<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <title>ArcGIS JavaScript Tutorials: Create a Starter App</title>
    <style>
      html,
      body,
      #mapDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
        cursor: pointer;
      }
    </style>

    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.12/esri/css/main.css"
    />
    <script src="https://js.arcgis.com/4.12/"></script>
    <script>
      require([
        "esri/Map",
        "esri/views/MapView",
        "esri/Graphic",
        "esri/geometry/Point",
        "esri/widgets/Search",
        "esri/request"
      ], function(Map, MapView, Graphic, Point, Search, esriRequest) {
        var map = new Map({
          basemap: "osm"
        });

        var mapView = new MapView({
          container: "mapDiv",
          map: map,
          center: [118, -3.8],
          zoom: 5
        });

        var searchWidget = new Search({
          view: mapView
        });
        // Adds the search widget below other elements in
        // the top left corner of the view
        mapView.ui.add(searchWidget, {
          position: "top-right",
          index: 2
        });

        mapView.on("click", function(event) {
          mapView.graphics.removeAll();
          let latitude = mapView
            .toMap({
              x: event.x,
              y: event.y
            })
            .latitude.toFixed(7);

          let longitude = mapView
            .toMap({
              x: event.x,
              y: event.y
            })
            .longitude.toFixed(7);

          var url =
            "http://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/reverseGeocode?f=pjson&featureTypes=&location=" +
            longitude +
            "," +
            latitude;

          esriRequest(url, {
            responseType: "json"
          }).then(function(response) {
            console.log(response.data.address); //Alamat address yang didapatkan setelah melakukan pointing
          });

          let point = new Point({
            longitude: longitude,
            latitude: latitude
          });

          let markerSymbol = {
            type: "picture-marker",
            url:
              "https://cdn0.iconfinder.com/data/icons/small-n-flat/24/678111-map-marker-512.png",
            width: "24px",
            height: "24px"
          };

          let id = latitude.toString() + longitude.toString();
          let pointGraphic = new Graphic({
            geometry: point,
            symbol: markerSymbol,
            attributes: {
              id: id
            }
          });
          mapView.graphics.add(pointGraphic);
          console.log(latitude, longitude);
          mapView.goTo({
            target: pointGraphic,
            zoom: 13
          });
        });

        var pointThisAction = {
          title: "Pointing",
          id: "point-this",
          className: "esri-icon-map-pin"
        };

        mapView.popup.actions.push(pointThisAction);

        mapView.popup.on("trigger-action", ({ action }) => {
          if (action.id === "point-this") {
            mapView.graphics.removeAll();
            let attr = mapView.popup.selectedFeature;
            let lat = attr.geometry.latitude;
            let lon = attr.geometry.longitude;

            let point = new Point({
              longitude: lon,
              latitude: lat
            });

            let markerSymbol = {
              type: "picture-marker",
              url:
                "https://cdn0.iconfinder.com/data/icons/small-n-flat/24/678111-map-marker-512.png",
              width: "24px",
              height: "24px"
            };

            let id = lat.toString() + lon.toString();
            let pointGraphic = new Graphic({
              geometry: point,
              symbol: markerSymbol,
              attributes: {
                id: id
              }
            });
            mapView.graphics.add(pointGraphic);
            console.log(lat, lon);
            var url =
              "http://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/reverseGeocode?f=pjson&featureTypes=&location=" +
              lon +
              "," +
              lat;

            esriRequest(url, {
              responseType: "json"
            }).then(function(response) {
              console.log(response.data.address); //Alamat address yang didapatkan setelah melakukan pointing
            });
            
            mapView.goTo({
              target: pointGraphic,
              zoom: 13
            });
          }
        });
      });
    </script>
  </head>
  <body>
    <div id="mapDiv"></div>
  </body>
</html>
